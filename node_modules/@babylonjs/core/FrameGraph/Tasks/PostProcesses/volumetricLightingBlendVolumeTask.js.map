{"version":3,"file":"volumetricLightingBlendVolumeTask.js","sourceRoot":"","sources":["../../../../../../dev/core/src/FrameGraph/Tasks/PostProcesses/volumetricLightingBlendVolumeTask.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AbstractEngine, Camera, EffectWrapperCreationOptions, FrameGraph, FrameGraphRenderPass, FrameGraphTextureHandle, Nullable } from \"core/index\";\r\nimport { Vector3, Matrix } from \"core/Maths/math.vector\";\r\nimport { Constants } from \"core/Engines/constants\";\r\nimport { ThinPassPostProcess } from \"core/PostProcesses/thinPassPostProcess\";\r\nimport { FrameGraphPostProcessTask } from \"./postProcessTask\";\r\n\r\n/**\r\n * @internal\r\n */\r\nclass VolumetricLightingBlendVolumeThinPostProcess extends ThinPassPostProcess {\r\n    public camera: Camera;\r\n\r\n    public outputTextureWidth = 0;\r\n\r\n    public outputTextureHeight = 0;\r\n\r\n    public extinction = new Vector3(0, 0, 0);\r\n\r\n    public enableExtinction = false;\r\n\r\n    private _invProjection: Matrix;\r\n\r\n    protected override _gatherImports(useWebGPU: boolean, list: Promise<any>[]) {\r\n        if (useWebGPU) {\r\n            this._webGPUReady = true;\r\n            list.push(Promise.all([import(\"../../../ShadersWGSL/pass.fragment\"), import(\"../../../ShadersWGSL/volumetricLightingBlendVolume.fragment\")]));\r\n        } else {\r\n            list.push(Promise.all([import(\"../../../Shaders/pass.fragment\"), import(\"../../../Shaders/volumetricLightingBlendVolume.fragment\")]));\r\n        }\r\n\r\n        super._gatherImports(useWebGPU, list);\r\n    }\r\n\r\n    constructor(name: string, engine: Nullable<AbstractEngine> = null, enableExtinction = false, options?: EffectWrapperCreationOptions) {\r\n        super(name, engine, {\r\n            ...options,\r\n            fragmentShader: \"volumetricLightingBlendVolume\",\r\n            samplers: [\"depthSampler\"],\r\n            uniforms: [\"invProjection\", \"outputTextureSize\", \"extinction\"],\r\n            defines: enableExtinction ? [\"#define DUAL_SOURCE_BLENDING\", \"#define USE_EXTINCTION\"] : undefined,\r\n        });\r\n\r\n        this._invProjection = new Matrix();\r\n        this.alphaMode = enableExtinction ? Constants.ALPHA_DUAL_SRC0_ADD_SRC1xDST : Constants.ALPHA_ADD;\r\n    }\r\n\r\n    public override bind(noDefaultBindings = false) {\r\n        super.bind(noDefaultBindings);\r\n\r\n        const effect = this.drawWrapper.effect!;\r\n\r\n        this._invProjection.copyFrom(this.camera.getProjectionMatrix());\r\n        this._invProjection.invert();\r\n\r\n        effect.setMatrix(\"invProjection\", this._invProjection);\r\n        effect.setFloat2(\"outputTextureSize\", this.outputTextureWidth, this.outputTextureHeight);\r\n        effect.setVector3(\"extinction\", this.extinction);\r\n    }\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class FrameGraphVolumetricLightingBlendVolumeTask extends FrameGraphPostProcessTask {\r\n    public override readonly postProcess: VolumetricLightingBlendVolumeThinPostProcess;\r\n\r\n    public depthTexture: FrameGraphTextureHandle;\r\n\r\n    public camera: Camera;\r\n\r\n    constructor(name: string, frameGraph: FrameGraph, enableExtinction = false) {\r\n        super(name, frameGraph, new VolumetricLightingBlendVolumeThinPostProcess(name, frameGraph.engine, enableExtinction));\r\n    }\r\n\r\n    public override getClassName(): string {\r\n        return \"FrameGraphVolumetricLightingBlendVolumeTask\";\r\n    }\r\n\r\n    public override record(skipCreationOfDisabledPasses = false): FrameGraphRenderPass {\r\n        if (this.sourceTexture === undefined || this.depthTexture === undefined || this.camera === undefined) {\r\n            throw new Error(`FrameGraphVolumetricLightingBlendVolumeTask \"${this.name}\": sourceTexture, depthTexture and camera are required`);\r\n        }\r\n\r\n        const pass = super.record(skipCreationOfDisabledPasses, undefined, (context) => {\r\n            this.postProcess.camera = this.camera;\r\n            context.bindTextureHandle(this._postProcessDrawWrapper.effect!, \"depthSampler\", this.depthTexture);\r\n        });\r\n\r\n        pass.addDependencies(this.depthTexture);\r\n\r\n        this.postProcess.outputTextureWidth = this._outputWidth;\r\n        this.postProcess.outputTextureHeight = this._outputHeight;\r\n\r\n        return pass;\r\n    }\r\n}\r\n"]}