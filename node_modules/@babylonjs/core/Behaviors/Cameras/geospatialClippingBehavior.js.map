{"version":3,"file":"geospatialClippingBehavior.js","sourceRoot":"","sources":["../../../../../dev/core/src/Behaviors/Cameras/geospatialClippingBehavior.ts"],"names":[],"mappings":"AAMA;;;;;;GAMG;AACH,MAAM,OAAO,0BAA0B;IAAvC;QAQY,oBAAe,GAA+B,IAAI,CAAC;QACnD,4BAAuB,GAA8B,IAAI,CAAC;IAiEtE,CAAC;IAzEG;;OAEG;IACH,IAAW,IAAI;QACX,OAAO,oBAAoB,CAAC;IAChC,CAAC;IAKD;;OAEG;IACH,IAAW,YAAY;QACnB,OAAO,IAAI,CAAC,eAAe,CAAC;IAChC,CAAC;IAED;;OAEG;IACI,IAAI;QACP,aAAa;IACjB,CAAC;IAED;;;OAGG;IACI,MAAM,CAAC,MAAwB;QAClC,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC;QAC9B,MAAM,KAAK,GAAG,MAAM,CAAC,QAAQ,EAAE,CAAC;QAEhC,IAAI,CAAC,uBAAuB,GAAG,KAAK,CAAC,wBAAwB,CAAC,GAAG,CAAC,GAAG,EAAE;YACnE,IAAI,CAAC,uBAAuB,EAAE,CAAC;QACnC,CAAC,CAAC,CAAC;IACP,CAAC;IAED;;OAEG;IACI,MAAM;QACT,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;YACvB,MAAM,KAAK,GAAG,IAAI,CAAC,eAAe,CAAC,QAAQ,EAAE,CAAC;YAC9C,IAAI,IAAI,CAAC,uBAAuB,EAAE,CAAC;gBAC/B,KAAK,CAAC,wBAAwB,CAAC,MAAM,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;gBACpE,IAAI,CAAC,uBAAuB,GAAG,IAAI,CAAC;YACxC,CAAC;QACL,CAAC;QACD,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;IAChC,CAAC;IAED;;OAEG;IACK,uBAAuB;QAC3B,MAAM,MAAM,GAAG,IAAI,CAAC,eAAe,CAAC;QACpC,IAAI,CAAC,MAAM,EAAE,CAAC;YACV,OAAO;QACX,CAAC;QAED,MAAM,YAAY,GAAG,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC;QAChD,wEAAwE;QACxE,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,GAAG,YAAY,CAAC,CAAC;QAEtE,qEAAqE;QACrE,6GAA6G;QAC7G,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,QAAQ,GAAG,KAAK,CAAC,CAAC;QAE5C,2CAA2C;QAC3C,0EAA0E;QAC1E,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,CAAC,GAAG,YAAY,GAAG,QAAQ,GAAG,QAAQ,GAAG,QAAQ,CAAC,CAAC;QACjF,MAAM,CAAC,IAAI,GAAG,WAAW,GAAG,YAAY,GAAG,GAAG,CAAC;IACnD,CAAC;CACJ","sourcesContent":["import type { Behavior } from \"../../Behaviors/behavior\";\r\nimport type { GeospatialCamera } from \"../../Cameras/geospatialCamera\";\r\nimport type { Nullable } from \"../../types\";\r\nimport type { Observer } from \"../../Misc/observable\";\r\nimport type { Scene } from \"../../scene\";\r\n\r\n/**\r\n * The GeospatialClippingBehavior automatically adjusts the near and far clip planes of a GeospatialCamera\r\n * based on altitude to optimize depth buffer precision for geospatial applications.\r\n *\r\n * The near plane scales with altitude (distance to planet surface) to maintain good depth precision.\r\n * The far plane is calculated based on the visible horizon distance.\r\n */\r\nexport class GeospatialClippingBehavior implements Behavior<GeospatialCamera> {\r\n    /**\r\n     * Gets the name of the behavior.\r\n     */\r\n    public get name(): string {\r\n        return \"GeospatialClipping\";\r\n    }\r\n\r\n    private _attachedCamera: Nullable<GeospatialCamera> = null;\r\n    private _onBeforeRenderObserver: Nullable<Observer<Scene>> = null;\r\n\r\n    /**\r\n     * Gets the attached camera.\r\n     */\r\n    public get attachedNode(): Nullable<GeospatialCamera> {\r\n        return this._attachedCamera;\r\n    }\r\n\r\n    /**\r\n     * Initializes the behavior.\r\n     */\r\n    public init(): void {\r\n        // Do nothing\r\n    }\r\n\r\n    /**\r\n     * Attaches the behavior to its geospatial camera.\r\n     * @param camera Defines the camera to attach the behavior to\r\n     */\r\n    public attach(camera: GeospatialCamera): void {\r\n        this._attachedCamera = camera;\r\n        const scene = camera.getScene();\r\n\r\n        this._onBeforeRenderObserver = scene.onBeforeRenderObservable.add(() => {\r\n            this._updateCameraClipPlanes();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Detaches the behavior from its current geospatial camera.\r\n     */\r\n    public detach(): void {\r\n        if (this._attachedCamera) {\r\n            const scene = this._attachedCamera.getScene();\r\n            if (this._onBeforeRenderObserver) {\r\n                scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserver);\r\n                this._onBeforeRenderObserver = null;\r\n            }\r\n        }\r\n        this._attachedCamera = null;\r\n    }\r\n\r\n    /**\r\n     * Updates the camera's near and far clip planes based on altitude.\r\n     */\r\n    private _updateCameraClipPlanes(): void {\r\n        const camera = this._attachedCamera;\r\n        if (!camera) {\r\n            return;\r\n        }\r\n\r\n        const planetRadius = camera.limits.planetRadius;\r\n        // Camera position length gives distance to world origin (planet center)\r\n        const altitude = Math.max(1, camera.position.length() - planetRadius);\r\n\r\n        // Near plane: scale with altitude to maintain depth buffer precision\r\n        // Use a fraction of altitude - the closest visible point on a sphere is straight down at distance = altitude\r\n        camera.minZ = Math.max(1, altitude * 0.001);\r\n\r\n        // Far plane: see to the horizon and beyond\r\n        // Horizon distance formula: √(2Rh + h²) where h is altitude above surface\r\n        const horizonDist = Math.sqrt(2 * planetRadius * altitude + altitude * altitude);\r\n        camera.maxZ = horizonDist + planetRadius * 0.1;\r\n    }\r\n}\r\n"]}