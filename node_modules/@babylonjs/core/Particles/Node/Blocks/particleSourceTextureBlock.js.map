{"version":3,"file":"particleSourceTextureBlock.js","sourceRoot":"","sources":["../../../../../../dev/core/src/Particles/Node/Blocks/particleSourceTextureBlock.ts"],"names":[],"mappings":"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","sourcesContent":["import type { NodeParticleConnectionPoint } from \"../nodeParticleBlockConnectionPoint\";\r\nimport type { NodeParticleBuildState } from \"../nodeParticleBuildState\";\r\nimport type { Nullable } from \"core/types\";\r\nimport type { BaseTexture } from \"../../../Materials/Textures/baseTexture\";\r\nimport type { ProceduralTexture } from \"../../../Materials/Textures/Procedurals/proceduralTexture\";\r\n\r\nimport { Texture } from \"core/Materials/Textures/texture\";\r\nimport { RegisterClass } from \"../../../Misc/typeStore\";\r\nimport { NodeParticleBlockConnectionPointTypes } from \"../Enums/nodeParticleBlockConnectionPointTypes\";\r\nimport { NodeParticleBlock } from \"../nodeParticleBlock\";\r\nimport { TextureTools } from \"core/Misc/textureTools\";\r\n\r\n/**\r\n * Interface used to define texture data\r\n */\r\nexport interface INodeParticleTextureData {\r\n    /** Width of the texture in pixels */\r\n    width: number;\r\n    /** Height of the texture in pixels */\r\n    height: number;\r\n    /** RGBA pixel data */\r\n    data: Uint8ClampedArray;\r\n}\r\n\r\n/**\r\n * Block used to provide a texture for particles in a particle system\r\n */\r\nexport class ParticleTextureSourceBlock extends NodeParticleBlock {\r\n    private _url: string = \"\";\r\n    private _textureDataUrl: string = \"\";\r\n    private _sourceTexture: Nullable<BaseTexture> = null;\r\n    private _cachedData: Nullable<INodeParticleTextureData> = null;\r\n    private _clonedTextures: BaseTexture[] = [];\r\n\r\n    /**\r\n     * Gets or sets the strenght of the flow map effect\r\n     */\r\n    public invertY = true;\r\n\r\n    /**\r\n     * Indicates if the texture data should be serialized as a base64 string.\r\n     */\r\n    public serializedCachedData: boolean = false;\r\n\r\n    /**\r\n     * Gets or sets the URL of the texture to be used by this block.\r\n     */\r\n    public get url(): string {\r\n        return this._url;\r\n    }\r\n\r\n    public set url(value: string) {\r\n        if (this._url === value) {\r\n            return;\r\n        }\r\n        this._cachedData = null;\r\n        this._url = value;\r\n        this._textureDataUrl = \"\";\r\n        this._sourceTexture = null;\r\n    }\r\n\r\n    /**\r\n     * Gets or sets the data URL of the texture to be used by this block.\r\n     * This is a base64 encoded string representing the texture data.\r\n     */\r\n    public get textureDataUrl(): string {\r\n        return this._textureDataUrl;\r\n    }\r\n\r\n    public set textureDataUrl(value: string) {\r\n        if (this._textureDataUrl === value) {\r\n            return;\r\n        }\r\n\r\n        this._cachedData = null;\r\n        this._textureDataUrl = value;\r\n        this._url = \"\";\r\n        this._sourceTexture = null;\r\n    }\r\n\r\n    /**\r\n     * Gets the texture directly set on this block.\r\n     * This value will not be serialized.\r\n     */\r\n    public get sourceTexture(): Nullable<BaseTexture> {\r\n        return this._sourceTexture;\r\n    }\r\n\r\n    /**\r\n     * Directly sets the texture to be used by this block.\r\n     * This value will not be serialized.\r\n     */\r\n    public set sourceTexture(value: Nullable<BaseTexture>) {\r\n        if (this._sourceTexture === value) {\r\n            return;\r\n        }\r\n        this._cachedData = null;\r\n        this._sourceTexture = value;\r\n        this._url = (value as Texture).url || \"\";\r\n        this._textureDataUrl = \"\";\r\n    }\r\n\r\n    /**\r\n     * Create a new ParticleTextureSourceBlock\r\n     * @param name defines the block name\r\n     */\r\n    public constructor(name: string) {\r\n        super(name);\r\n\r\n        this.registerOutput(\"texture\", NodeParticleBlockConnectionPointTypes.Texture);\r\n    }\r\n\r\n    /**\r\n     * Gets the current class name\r\n     * @returns the class name\r\n     */\r\n    public override getClassName() {\r\n        return \"ParticleTextureSourceBlock\";\r\n    }\r\n\r\n    /**\r\n     * Gets the texture output component\r\n     */\r\n    public get texture(): NodeParticleConnectionPoint {\r\n        return this._outputs[0];\r\n    }\r\n\r\n    /**\r\n     * Gets the texture content as a promise\r\n     * @returns a promise that resolves to the texture content, including width, height, and pixel data\r\n     */\r\n    async extractTextureContentAsync() {\r\n        if (!this.texture._storedValue && !this._sourceTexture) {\r\n            return null;\r\n        }\r\n\r\n        if (this._cachedData) {\r\n            return this._cachedData;\r\n        }\r\n\r\n        const texture = this.texture._storedValue || this._sourceTexture;\r\n        return await new Promise<\r\n            Nullable<{\r\n                width: number;\r\n                height: number;\r\n                data: Uint8ClampedArray;\r\n            }>\r\n        >((resolve, reject) => {\r\n            if (!texture.isReady()) {\r\n                texture.onLoadObservable.addOnce(async () => {\r\n                    try {\r\n                        this._cachedData = await this.extractTextureContentAsync();\r\n                        resolve(this._cachedData);\r\n                    } catch (e) {\r\n                        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\r\n                        reject(e);\r\n                    }\r\n                });\r\n                return;\r\n            }\r\n            const size = texture.getSize();\r\n            if (texture.getContent) {\r\n                const proceduralTexture = texture as ProceduralTexture;\r\n                proceduralTexture\r\n                    .getContent()\r\n                    // eslint-disable-next-line github/no-then\r\n                    ?.then((data) => {\r\n                        this._cachedData = {\r\n                            width: size.width,\r\n                            height: size.height,\r\n                            data: new Uint8ClampedArray(data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength)),\r\n                        };\r\n                        resolve(this._cachedData);\r\n                    })\r\n                    // eslint-disable-next-line github/no-then\r\n                    .catch(reject);\r\n            } else {\r\n                TextureTools.GetTextureDataAsync(texture, size.width, size.height)\r\n                    // eslint-disable-next-line github/no-then\r\n                    .then((data) => {\r\n                        this._cachedData = {\r\n                            width: size.width,\r\n                            height: size.height,\r\n                            data: new Uint8ClampedArray(data),\r\n                        };\r\n                        texture.dispose();\r\n                        resolve(this._cachedData);\r\n                    })\r\n                    // eslint-disable-next-line github/no-then\r\n                    .catch(reject);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Builds the block\r\n     * @param state defines the current build state\r\n     */\r\n    public override _build(state: NodeParticleBuildState) {\r\n        if (this._sourceTexture) {\r\n            // The same NodeParticleSystemSet can be built into multiple scenes/engines\r\n            // (original system scene, editor preview scene).\r\n            // Textures are engine-specific, so we need to handle cross-engine cases.\r\n            const sourceScene = this._sourceTexture.getScene?.();\r\n            const sourceEngine = sourceScene?.getEngine?.();\r\n            const targetEngine = state.scene.getEngine();\r\n\r\n            if (sourceEngine && sourceEngine !== targetEngine) {\r\n                // Cross-engine: recreate texture from URL if available, preserving invertY\r\n                const url = (this._sourceTexture as Texture).url || this._url;\r\n                if (url) {\r\n                    const invertY = (this._sourceTexture as Texture).invertY ?? this.invertY;\r\n                    const tex = new Texture(url, state.scene, undefined, invertY);\r\n                    this._copyTextureProperties(this._sourceTexture, tex);\r\n                    this._clonedTextures.push(tex);\r\n                    this.texture._storedValue = tex;\r\n                    return;\r\n                }\r\n                // No URL available - use the source texture directly as fallback\r\n                // This may not render correctly but avoids breaking completely\r\n                this.texture._storedValue = this._sourceTexture;\r\n                return;\r\n            }\r\n\r\n            // Same engine: clone works correctly and preserves all properties\r\n            const cloned = this._sourceTexture.clone();\r\n            if (cloned) {\r\n                this._clonedTextures.push(cloned);\r\n                this.texture._storedValue = cloned;\r\n            } else {\r\n                this.texture._storedValue = this._sourceTexture;\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (!this._textureDataUrl && !this._url) {\r\n            this.texture._storedValue = null;\r\n            return;\r\n        }\r\n\r\n        if (this._textureDataUrl) {\r\n            const tex = new Texture(this._textureDataUrl, state.scene, undefined, this.invertY);\r\n            this._clonedTextures.push(tex);\r\n            this.texture._storedValue = tex;\r\n            return;\r\n        }\r\n\r\n        const tex = new Texture(this._url, state.scene, undefined, this.invertY);\r\n        this._clonedTextures.push(tex);\r\n        this.texture._storedValue = tex;\r\n    }\r\n\r\n    /**\r\n     * Serializes this block\r\n     * @returns the serialization object\r\n     */\r\n    public override serialize(): any {\r\n        const serializationObject = super.serialize();\r\n\r\n        serializationObject.url = this.url;\r\n        serializationObject.serializedCachedData = this.serializedCachedData;\r\n        serializationObject.invertY = this.invertY;\r\n\r\n        if (this.serializedCachedData) {\r\n            serializationObject.textureDataUrl = this.textureDataUrl;\r\n        }\r\n\r\n        return serializationObject;\r\n    }\r\n\r\n    /**\r\n     * Deserializes this block from a serialization object\r\n     * @param serializationObject the serialization object\r\n     */\r\n    public override _deserialize(serializationObject: any) {\r\n        super._deserialize(serializationObject);\r\n\r\n        this.url = serializationObject.url;\r\n        this.serializedCachedData = !!serializationObject.serializedCachedData;\r\n        this.invertY = !!serializationObject.invertY;\r\n\r\n        if (serializationObject.textureDataUrl) {\r\n            this.textureDataUrl = serializationObject.textureDataUrl;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disposes the block and its associated resources\r\n     */\r\n    public override dispose(): void {\r\n        // Dispose all cloned textures we created\r\n        for (const tex of this._clonedTextures) {\r\n            tex.dispose();\r\n        }\r\n        this._clonedTextures = [];\r\n        this.texture._storedValue = null;\r\n        // Never dispose _sourceTexture - it's owned by the caller\r\n        super.dispose();\r\n    }\r\n\r\n    /**\r\n     * Copies texture properties from source to target texture\r\n     * @param source - The source texture to copy properties from\r\n     * @param target - The target texture to copy properties to\r\n     */\r\n    private _copyTextureProperties(source: BaseTexture, target: BaseTexture): void {\r\n        // BaseTexture properties\r\n        target.hasAlpha = source.hasAlpha;\r\n        target.level = source.level;\r\n        target.coordinatesIndex = source.coordinatesIndex;\r\n        target.coordinatesMode = source.coordinatesMode;\r\n        target.wrapU = source.wrapU;\r\n        target.wrapV = source.wrapV;\r\n        target.wrapR = source.wrapR;\r\n        target.anisotropicFilteringLevel = source.anisotropicFilteringLevel;\r\n\r\n        // Texture-specific properties (if both are Texture instances)\r\n        const sourceTexture = source as Texture;\r\n        const targetTexture = target as Texture;\r\n        if (sourceTexture.uOffset !== undefined && targetTexture.uOffset !== undefined) {\r\n            targetTexture.uOffset = sourceTexture.uOffset;\r\n            targetTexture.vOffset = sourceTexture.vOffset;\r\n            targetTexture.uScale = sourceTexture.uScale;\r\n            targetTexture.vScale = sourceTexture.vScale;\r\n            targetTexture.uAng = sourceTexture.uAng;\r\n            targetTexture.vAng = sourceTexture.vAng;\r\n            targetTexture.wAng = sourceTexture.wAng;\r\n        }\r\n    }\r\n}\r\n\r\nRegisterClass(\"BABYLON.ParticleTextureSourceBlock\", ParticleTextureSourceBlock);\r\n"]}