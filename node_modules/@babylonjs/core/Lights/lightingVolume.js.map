{"version":3,"file":"lightingVolume.js","sourceRoot":"","sources":["../../../../dev/core/src/Lights/lightingVolume.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AbstractEngine, Engine, Nullable, RenderTargetWrapper, Scene, ShadowGenerator, WebGPUEngine } from \"core/index\";\r\nimport { AbortError } from \"core/Misc/error\";\r\nimport { Constants } from \"core/Engines/constants\";\r\nimport { Matrix, Vector3, TmpVectors } from \"core/Maths/math.vector\";\r\nimport { DirectionalLight } from \"core/Lights/directionalLight\";\r\nimport { Mesh } from \"core/Meshes/mesh\";\r\nimport { ComputeShader } from \"core/Compute/computeShader\";\r\nimport { CopyTextureToTexture } from \"core/Misc/copyTextureToTexture\";\r\nimport { UniformBuffer } from \"core/Materials/uniformBuffer\";\r\nimport { StorageBuffer } from \"core/Buffers/storageBuffer\";\r\nimport { BaseTexture } from \"core/Materials/Textures/baseTexture\";\r\nimport { VertexBuffer } from \"core/Buffers/buffer\";\r\n\r\nimport \"core/ShadersWGSL/lightingVolume.compute\";\r\n\r\nconst TmpVec3 = new Vector3();\r\n\r\n/**\r\n * Class used to create a lighting volume from a directional light's shadow generator.\r\n */\r\nexport class LightingVolume {\r\n    private readonly _engine: AbstractEngine;\r\n    private readonly _scene: Scene;\r\n    private readonly _mesh: Mesh;\r\n    private readonly _copyTexture?: CopyTextureToTexture;\r\n    private readonly _uBuffer?: UniformBuffer;\r\n    private readonly _buildFullVolume = true;\r\n    private _name: string;\r\n    private _cs?: ComputeShader;\r\n    private _cs2?: ComputeShader;\r\n    private _light?: DirectionalLight;\r\n    private _fallbackTexture?: BaseTexture;\r\n    private _storageBuffer?: StorageBuffer;\r\n    private _depthCopy?: RenderTargetWrapper;\r\n    private _readPixelPromise: Nullable<Promise<ArrayBufferView>> = null;\r\n    private _readPixelAbortController: Nullable<AbortController> = null;\r\n    private _numFrames = 0;\r\n    private _firstUpdate = true;\r\n    private _currentLightDirection = new Vector3();\r\n    private _positions: Float32Array;\r\n    private _indices: number[];\r\n    private _needFullUpdateUBO = true;\r\n\r\n    private _shadowGenerator?: ShadowGenerator;\r\n    /**\r\n     * The shadow generator used to create the lighting volume.\r\n     */\r\n    public get shadowGenerator() {\r\n        return this._shadowGenerator!;\r\n    }\r\n\r\n    public set shadowGenerator(sg: ShadowGenerator) {\r\n        const light = sg.getLight();\r\n\r\n        if (!(light instanceof DirectionalLight)) {\r\n            throw new Error(`LightingVolumeMesh ${this._name}: light must be a directional light`);\r\n        }\r\n\r\n        this._shadowGenerator = sg;\r\n        this._light = light;\r\n\r\n        this._updateGeometry();\r\n\r\n        if (!this._engine.isWebGPU) {\r\n            this._createFallbackTextures();\r\n        }\r\n\r\n        this._setComputeShaderInputs();\r\n    }\r\n\r\n    private _tesselation = 0;\r\n    /**\r\n     * The tesselation level of the lighting volume.\r\n     */\r\n    public get tesselation() {\r\n        return this._tesselation;\r\n    }\r\n\r\n    public set tesselation(n: number) {\r\n        this._tesselation = n;\r\n        this._createGeometry();\r\n    }\r\n\r\n    /**\r\n     * The mesh used as a support for the lighting volume.\r\n     * Note that this mesh is not automatically added to the scene's mesh array.\r\n     * If you want to render it, you need to add it manually.\r\n     */\r\n    public get mesh() {\r\n        return this._mesh;\r\n    }\r\n\r\n    private _frequency = 1;\r\n\r\n    /**\r\n     * The frequency (in number of times you call updateMesh) at which the lighting volume is updated.\r\n     */\r\n    public get frequency() {\r\n        return this._frequency;\r\n    }\r\n\r\n    public set frequency(value: number) {\r\n        this._frequency = value;\r\n        this._firstUpdate = true;\r\n    }\r\n\r\n    /**\r\n     * The name of the lighting volume.\r\n     */\r\n    public get name() {\r\n        return this._name;\r\n    }\r\n\r\n    public set name(name: string) {\r\n        this._name = name;\r\n        if (this._mesh) {\r\n            this._mesh.name = name;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Indicates whether this is the first update of the lighting volume.\r\n     * If true, the volume has not yet been updated for the first time.\r\n     */\r\n    public get firstUpdate() {\r\n        return this._firstUpdate;\r\n    }\r\n\r\n    /** @internal */\r\n    public _setComputeShaderFastMode(enabled: boolean) {\r\n        if (this._cs) {\r\n            this._cs.fastMode = enabled;\r\n            this._cs.triggerContextRebuild = enabled;\r\n        }\r\n        if (this._cs2) {\r\n            this._cs2.fastMode = enabled;\r\n            this._cs2.triggerContextRebuild = enabled;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates a new LightingVolume.\r\n     * @param name The name of the lighting volume.\r\n     * @param scene The scene the lighting volume belongs to.\r\n     * @param shadowGenerator The shadow generator used to create the lighting volume. This is optional in the constructor, but must be set before calling updateMesh.\r\n     * @param tesselation The tesselation level of the lighting volume (default: 64).\r\n     */\r\n    constructor(name: string, scene: Scene, shadowGenerator?: ShadowGenerator, tesselation = 64) {\r\n        const light = shadowGenerator ? shadowGenerator.getLight() : undefined;\r\n\r\n        if (light && !(light instanceof DirectionalLight)) {\r\n            throw new Error(`LightingVolumeMesh ${name}: light must be a directional light`);\r\n        }\r\n\r\n        this._name = name;\r\n        this._shadowGenerator = shadowGenerator;\r\n        this._light = light as DirectionalLight;\r\n        this._indices = [];\r\n\r\n        this._engine = scene.getEngine();\r\n        this._scene = scene;\r\n\r\n        this._mesh = new Mesh(name, this._scene);\r\n        scene.meshes.splice(scene.meshes.indexOf(this._mesh), 1);\r\n\r\n        if (this._engine.isWebGPU) {\r\n            this._uBuffer = new UniformBuffer(this._engine);\r\n\r\n            this._uBuffer.addUniform(\"invViewProjMatrix\", 16);\r\n            this._uBuffer.addUniform(\"invViewMatrix\", 16);\r\n            this._uBuffer.addUniform(\"startVertexIndex\", 1);\r\n            this._uBuffer.addUniform(\"step\", 1);\r\n            this._uBuffer.addUniform(\"tesselation\", 1);\r\n            this._uBuffer.addUniform(\"orthoMin\", 3);\r\n            this._uBuffer.addUniform(\"orthoMax\", 3);\r\n            this._uBuffer.update();\r\n\r\n            this._createComputeShader();\r\n        } else {\r\n            this._copyTexture = new CopyTextureToTexture(this._engine, false, true);\r\n            this._createFallbackTextures();\r\n        }\r\n\r\n        this._tesselation = tesselation;\r\n        this._createGeometry();\r\n    }\r\n\r\n    /**\r\n     * Checks if the lighting volume is ready to be updated.\r\n     * @returns True if the volume is ready to be updated.\r\n     */\r\n    public isReady() {\r\n        let isReady = this._mesh.isReady(true);\r\n        if (this._cs) {\r\n            isReady = this._cs.isReady() && isReady;\r\n        }\r\n        if (this._cs2) {\r\n            isReady = this._cs2.isReady() && isReady;\r\n        }\r\n        return isReady;\r\n    }\r\n\r\n    /**\r\n     * Updates the lighting volume mesh.\r\n     * @param forceUpdate If true, forces the update even if the frequency condition is not met.\r\n     */\r\n    public update(forceUpdate = false) {\r\n        if (this._tesselation === 0 || !this._shadowGenerator) {\r\n            return;\r\n        }\r\n\r\n        if (!forceUpdate && !this._firstUpdate && (this.frequency === 0 || ++this._numFrames < this.frequency)) {\r\n            return;\r\n        }\r\n\r\n        this._numFrames = 0;\r\n\r\n        if (this._engine.isWebGPU) {\r\n            this._uBuffer!.updateMatrix(\"invViewProjMatrix\", this._shadowGenerator.getTransformMatrix().invertToRef(TmpVectors.Matrix[0]));\r\n\r\n            if (this._engine._enableGPUDebugMarkers) {\r\n                this._engine.restoreDefaultFramebuffer(true);\r\n                this._engine._debugPushGroup?.(`Update lighting volume (${this._name})`);\r\n            }\r\n\r\n            if (this._needUpdateGeometry()) {\r\n                this._fullUpdateUBO(true);\r\n\r\n                const dispatchSize = Math.ceil((this._tesselation + 1) / 32);\r\n\r\n                this._engine._debugPushGroup?.(`Update vertices of other planes`);\r\n                this._cs2!.dispatch(dispatchSize, 1, 1);\r\n                this._engine._debugPopGroup?.();\r\n            } else {\r\n                this._fullUpdateUBO();\r\n            }\r\n\r\n            const dispatchSize = Math.ceil((this._tesselation + 1) / 8);\r\n\r\n            this._engine._debugPushGroup?.(`Update vertices of far plane`);\r\n            this._cs!.dispatch(dispatchSize, dispatchSize, 1);\r\n            this._engine._debugPopGroup?.();\r\n\r\n            if (this._engine._enableGPUDebugMarkers) {\r\n                this._engine._debugPopGroup?.();\r\n            }\r\n\r\n            this._firstUpdate = false;\r\n        } else {\r\n            try {\r\n                void this._fallbackReadPixelAsync();\r\n            } catch {\r\n                this._readPixelPromise = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disposes the lighting volume and associated resources.\r\n     */\r\n    public dispose() {\r\n        this._readPixelAbortController?.abort(new AbortError(\"LightingVolume is disposed\"));\r\n        this._readPixelAbortController = null;\r\n        this._mesh.dispose();\r\n        if (this._fallbackTexture) {\r\n            this._fallbackTexture._texture = null;\r\n        }\r\n        this._fallbackTexture?.dispose();\r\n        this._copyTexture?.dispose();\r\n        this._storageBuffer?.dispose();\r\n        this._uBuffer?.dispose();\r\n        this._depthCopy?.dispose();\r\n    }\r\n\r\n    private _needUpdateGeometry() {\r\n        if (this._cs?.triggerContextRebuild || (this._light && !this._currentLightDirection.equals(this._light.direction))) {\r\n            this._currentLightDirection.copyFrom(this._light!.direction);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    private _createComputeShader() {\r\n        this._cs = new ComputeShader(\"updateFarPlaneVertices\", this._engine, \"lightingVolume\", {\r\n            bindingsMapping: {\r\n                shadowMap: { group: 0, binding: 0 },\r\n                params: { group: 0, binding: 1 },\r\n                positions: { group: 0, binding: 2 },\r\n            },\r\n            defines: !this._buildFullVolume ? [\"#define KEEP_EDGES\", \"#define MOVE_FAR_DEPTH_TO_NEAR\"] : undefined,\r\n            entryPoint: \"updateFarPlaneVertices\",\r\n        });\r\n\r\n        this._cs2 = new ComputeShader(\"updatePlaneVertices\", this._engine, \"lightingVolume\", {\r\n            bindingsMapping: {\r\n                shadowMap: { group: 0, binding: 0 },\r\n                params: { group: 0, binding: 1 },\r\n                positions: { group: 0, binding: 2 },\r\n            },\r\n            entryPoint: \"updatePlaneVertices\",\r\n        });\r\n\r\n        this._setComputeShaderInputs();\r\n    }\r\n\r\n    private _setComputeShaderInputs() {\r\n        if (!this._engine.isWebGPU) {\r\n            return;\r\n        }\r\n\r\n        if (this._shadowGenerator) {\r\n            const depthTexture = this._shadowGenerator.getShadowMap()?.depthStencilTexture;\r\n            if (depthTexture) {\r\n                this._cs?.setInternalTexture(\"shadowMap\", depthTexture);\r\n                this._cs2?.setInternalTexture(\"shadowMap\", depthTexture);\r\n            }\r\n        }\r\n\r\n        if (this._uBuffer) {\r\n            this._cs?.setUniformBuffer(\"params\", this._uBuffer);\r\n            this._cs2?.setUniformBuffer(\"params\", this._uBuffer);\r\n        }\r\n        if (this._storageBuffer) {\r\n            this._cs?.setStorageBuffer(\"positions\", this._storageBuffer);\r\n            this._cs2?.setStorageBuffer(\"positions\", this._storageBuffer);\r\n        }\r\n    }\r\n\r\n    private _createFallbackTextures() {\r\n        if (!this._shadowGenerator) {\r\n            return;\r\n        }\r\n\r\n        this._readPixelAbortController?.abort(new AbortError(\"Fallback textures are being (re)created\"));\r\n        this._readPixelAbortController = new AbortController();\r\n\r\n        const mapSize = this._shadowGenerator.mapSize;\r\n\r\n        this._depthCopy?.dispose();\r\n        this._depthCopy = this._engine.createRenderTargetTexture(\r\n            { width: mapSize, height: mapSize },\r\n            {\r\n                type: Constants.TEXTURETYPE_FLOAT,\r\n                format: Constants.TEXTUREFORMAT_RED,\r\n                samples: 1,\r\n                label: `${this._name} - fallback internal texture`,\r\n                generateDepthBuffer: false,\r\n            }\r\n        );\r\n\r\n        this._fallbackTexture?.dispose();\r\n        this._fallbackTexture = new BaseTexture(this._scene, this._depthCopy.texture);\r\n        this._fallbackTexture.name = `${this._name} - fallback texture`;\r\n    }\r\n\r\n    private async _fallbackReadPixelAsync() {\r\n        if (this._readPixelPromise || !this._fallbackTexture || !this._copyTexture) {\r\n            return;\r\n        }\r\n\r\n        const abortController = this._readPixelAbortController;\r\n\r\n        abortController?.signal.throwIfAborted();\r\n\r\n        const engine = this._engine as Engine;\r\n\r\n        const shadowGenerator = this._shadowGenerator;\r\n        const shadowMapDepthTexture = shadowGenerator?.getShadowMap()?.depthStencilTexture;\r\n\r\n        if (!shadowMapDepthTexture) {\r\n            return;\r\n        }\r\n\r\n        // Copies the shadow map of the shadow generator into _depthCopy\r\n        // That's because we can't read from a depth attachment texture in WebGL. We must first copy it to a regular texture.\r\n        engine.updateTextureSamplingMode(Constants.TEXTURE_NEAREST_SAMPLINGMODE, shadowMapDepthTexture);\r\n        engine.updateTextureComparisonFunction(shadowMapDepthTexture, 0);\r\n\r\n        this._copyTexture.copy(shadowMapDepthTexture, this._depthCopy);\r\n\r\n        engine.updateTextureComparisonFunction(shadowMapDepthTexture, Constants.LESS);\r\n\r\n        // Gets the texture from GPU to CPU\r\n        this._readPixelPromise = this._fallbackTexture.readPixels(0, 0, undefined, true, false);\r\n        if (!this._readPixelPromise) {\r\n            return;\r\n        }\r\n\r\n        const buffer = await this._readPixelPromise;\r\n\r\n        abortController?.signal.throwIfAborted();\r\n\r\n        const depthValues = buffer as Float32Array;\r\n        const positions = this._mesh.getVerticesData(\"position\");\r\n        const numTesselation = this._tesselation;\r\n        const startPos = this._buildFullVolume ? (numTesselation + 1) * 4 * 3 : 4 * 3;\r\n        const mapSize = shadowGenerator.mapSize;\r\n        const step = (mapSize - 1) / numTesselation;\r\n\r\n        if (!positions) {\r\n            this._readPixelPromise = null;\r\n            return;\r\n        }\r\n\r\n        const halfTesselation = numTesselation / 2;\r\n\r\n        const invViewProjMatrix = shadowGenerator.getTransformMatrix().clone();\r\n        invViewProjMatrix.invertToRef(invViewProjMatrix);\r\n\r\n        const factor = 4;\r\n\r\n        if (this._needUpdateGeometry()) {\r\n            this._updateGeometry();\r\n        }\r\n\r\n        let posIndex = startPos;\r\n        let stepY = 0;\r\n        for (let y = 0; y < numTesselation + 1; ++y) {\r\n            for (let x = 0; x < numTesselation + 1; ++x) {\r\n                let depth = depthValues[Math.floor(mapSize * Math.floor(stepY) + x * step) * factor];\r\n                if (!this._buildFullVolume) {\r\n                    if (y === 0 || x === 0 || y === numTesselation || x === numTesselation) {\r\n                        posIndex += 3;\r\n                        continue;\r\n                    }\r\n                    if (depth === 1) {\r\n                        depth = 0;\r\n                    }\r\n                }\r\n\r\n                TmpVec3.set((x - halfTesselation) / halfTesselation, (y - halfTesselation) / halfTesselation, -1 + 2 * depth);\r\n\r\n                Vector3.TransformCoordinatesToRef(TmpVec3, invViewProjMatrix, TmpVec3);\r\n\r\n                positions[posIndex] = TmpVec3.x;\r\n                positions[posIndex + 1] = TmpVec3.y;\r\n                positions[posIndex + 2] = TmpVec3.z;\r\n                posIndex += 3;\r\n            }\r\n            stepY += step;\r\n        }\r\n\r\n        this._mesh.setVerticesData(\"position\", positions);\r\n\r\n        this._readPixelPromise = null;\r\n        this._firstUpdate = false;\r\n    }\r\n\r\n    private _fullUpdateUBO(force = false) {\r\n        const light = this._light;\r\n\r\n        if ((!force && !this._needFullUpdateUBO) || !light || !this._shadowGenerator) {\r\n            this._uBuffer!.update();\r\n            return;\r\n        }\r\n\r\n        this._needFullUpdateUBO = false;\r\n\r\n        const numTesselation = this._tesselation;\r\n        const min = TmpVectors.Vector3[0].set(light.orthoLeft, light.orthoBottom, light.shadowMinZ ?? Constants.ShadowMinZ);\r\n        const max = TmpVectors.Vector3[1].set(light.orthoRight, light.orthoTop, light.shadowMaxZ ?? Constants.ShadowMaxZ);\r\n\r\n        const invViewMatrix = this._shadowGenerator.viewMatrix.invertToRef(TmpVectors.Matrix[1]);\r\n\r\n        this._uBuffer!.updateUInt(\"startVertexIndex\", this._buildFullVolume ? (numTesselation + 1) * 4 * 3 : 4 * 3);\r\n        this._uBuffer!.updateFloat(\"step\", ((this._shadowGenerator?.mapSize ?? 128) - 1) / numTesselation);\r\n        this._uBuffer!.updateUInt(\"tesselation\", numTesselation);\r\n        this._uBuffer!.updateVector3(\"orthoMin\", min);\r\n        this._uBuffer!.updateVector3(\"orthoMax\", max);\r\n        this._uBuffer!.updateMatrix(\"invViewMatrix\", invViewMatrix);\r\n        this._uBuffer!.update();\r\n    }\r\n\r\n    private _createGeometry() {\r\n        const light = this._light;\r\n\r\n        if (!light) {\r\n            return;\r\n        }\r\n\r\n        this._tesselation = Math.max(Math.ceil(this._tesselation) & ~1, 2);\r\n\r\n        const numTesselation = this._tesselation;\r\n        const vertexNumber = (numTesselation + 1) * (numTesselation + 1) + (this._buildFullVolume ? (numTesselation + 1) * 4 : 4);\r\n\r\n        this._positions = new Float32Array(vertexNumber * 3);\r\n        this._indices.length = 0;\r\n\r\n        this._createIndices(light);\r\n\r\n        this._mesh.setIndices(this._indices, vertexNumber);\r\n\r\n        if (this._engine.isWebGPU) {\r\n            const webGPUEngine = this._engine as WebGPUEngine;\r\n\r\n            this._storageBuffer?.dispose();\r\n            this._storageBuffer = new StorageBuffer(webGPUEngine, vertexNumber * 3 * 4, Constants.BUFFER_CREATIONFLAG_VERTEX | Constants.BUFFER_CREATIONFLAG_READWRITE);\r\n\r\n            this._mesh.setVerticesBuffer(new VertexBuffer(webGPUEngine, this._storageBuffer.getBuffer(), \"position\", { takeBufferOwnership: false }), true, vertexNumber);\r\n\r\n            this._setComputeShaderInputs();\r\n\r\n            this._cs!.triggerContextRebuild = true;\r\n            this._cs2!.triggerContextRebuild = true;\r\n\r\n            this._needFullUpdateUBO = true;\r\n        }\r\n\r\n        this._updateGeometry();\r\n    }\r\n\r\n    private _updateGeometry() {\r\n        const light = this._light;\r\n\r\n        if (!light || !this._shadowGenerator) {\r\n            return;\r\n        }\r\n\r\n        if (this._indices.length === 0) {\r\n            this._createGeometry();\r\n            return;\r\n        }\r\n\r\n        if (this._engine.isWebGPU) {\r\n            return;\r\n        }\r\n\r\n        const numTesselation = this._tesselation;\r\n\r\n        const min = TmpVectors.Vector3[0].set(light.orthoLeft, light.orthoBottom, light.shadowMinZ ?? Constants.ShadowMinZ);\r\n        const max = TmpVectors.Vector3[1].set(light.orthoRight, light.orthoTop, light.shadowMaxZ ?? Constants.ShadowMaxZ);\r\n\r\n        const invViewMatrix = this._shadowGenerator.viewMatrix.invertToRef(TmpVectors.Matrix[1]);\r\n\r\n        const stepX = (max.x - min.x) / numTesselation;\r\n        const stepY = (max.y - min.y) / numTesselation;\r\n\r\n        let vIndex = 0;\r\n\r\n        if (this._buildFullVolume) {\r\n            // Right faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                TmpVec3.set(max.x, min.y + i * stepY, min.z);\r\n                Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n                this._positions[vIndex++] = TmpVec3.x;\r\n                this._positions[vIndex++] = TmpVec3.y;\r\n                this._positions[vIndex++] = TmpVec3.z;\r\n            }\r\n\r\n            // Left faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                TmpVec3.set(min.x, min.y + i * stepY, min.z);\r\n                Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n                this._positions[vIndex++] = TmpVec3.x;\r\n                this._positions[vIndex++] = TmpVec3.y;\r\n                this._positions[vIndex++] = TmpVec3.z;\r\n            }\r\n\r\n            // Bottom faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                TmpVec3.set(min.x + i * stepX, min.y, min.z);\r\n                Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n                this._positions[vIndex++] = TmpVec3.x;\r\n                this._positions[vIndex++] = TmpVec3.y;\r\n                this._positions[vIndex++] = TmpVec3.z;\r\n            }\r\n\r\n            // Top faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                TmpVec3.set(min.x + i * stepX, max.y, min.z);\r\n                Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n                this._positions[vIndex++] = TmpVec3.x;\r\n                this._positions[vIndex++] = TmpVec3.y;\r\n                this._positions[vIndex++] = TmpVec3.z;\r\n            }\r\n        } else {\r\n            // Closes the volume with two near triangles\r\n            TmpVec3.set(max.x, min.y, min.z);\r\n            Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n            this._positions[vIndex++] = TmpVec3.x;\r\n            this._positions[vIndex++] = TmpVec3.y;\r\n            this._positions[vIndex++] = TmpVec3.z;\r\n\r\n            TmpVec3.set(max.x, max.y, min.z);\r\n            Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n            this._positions[vIndex++] = TmpVec3.x;\r\n            this._positions[vIndex++] = TmpVec3.y;\r\n            this._positions[vIndex++] = TmpVec3.z;\r\n\r\n            TmpVec3.set(min.x, min.y, min.z);\r\n            Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n            this._positions[vIndex++] = TmpVec3.x;\r\n            this._positions[vIndex++] = TmpVec3.y;\r\n            this._positions[vIndex++] = TmpVec3.z;\r\n\r\n            TmpVec3.set(min.x, max.y, min.z);\r\n            Vector3.TransformCoordinatesToRef(TmpVec3, invViewMatrix, TmpVec3);\r\n            this._positions[vIndex++] = TmpVec3.x;\r\n            this._positions[vIndex++] = TmpVec3.y;\r\n            this._positions[vIndex++] = TmpVec3.z;\r\n        }\r\n\r\n        this._mesh.setVerticesData(\"position\", this._positions);\r\n    }\r\n\r\n    private _createIndices(light: DirectionalLight) {\r\n        const invViewMatrix = Matrix.LookAtLH(light.position, light.position.add(light.direction), Vector3.UpReadOnly);\r\n        invViewMatrix.invertToRef(invViewMatrix);\r\n\r\n        const numTesselation = this._tesselation;\r\n\r\n        const startFarIndices = this._buildFullVolume ? (numTesselation + 1) * 4 : 4;\r\n\r\n        if (this._buildFullVolume) {\r\n            const rightFaceStartIndex = 0;\r\n\r\n            // Right faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                if (i < numTesselation) {\r\n                    this._indices.push(\r\n                        rightFaceStartIndex + i,\r\n                        startFarIndices + numTesselation + (i + 1) * (numTesselation + 1),\r\n                        startFarIndices + numTesselation + i * (numTesselation + 1)\r\n                    );\r\n                    this._indices.push(rightFaceStartIndex + i, rightFaceStartIndex + i + 1, startFarIndices + numTesselation + (i + 1) * (numTesselation + 1));\r\n                }\r\n            }\r\n\r\n            const leftFaceStartIndex = rightFaceStartIndex + numTesselation + 1;\r\n\r\n            // Left faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                if (i < numTesselation) {\r\n                    this._indices.push(leftFaceStartIndex + i, startFarIndices + 0 + i * (numTesselation + 1), startFarIndices + 0 + (i + 1) * (numTesselation + 1));\r\n                    this._indices.push(leftFaceStartIndex + i, startFarIndices + 0 + (i + 1) * (numTesselation + 1), leftFaceStartIndex + i + 1);\r\n                }\r\n            }\r\n\r\n            const bottomFaceStartIndex = leftFaceStartIndex + numTesselation + 1;\r\n\r\n            // Bottom faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                if (i < numTesselation) {\r\n                    this._indices.push(bottomFaceStartIndex + i, bottomFaceStartIndex + i + 1, startFarIndices + i + 0 * (numTesselation + 1));\r\n                    this._indices.push(bottomFaceStartIndex + i + 1, startFarIndices + i + 1 + 0 * (numTesselation + 1), startFarIndices + i + 0 * (numTesselation + 1));\r\n                }\r\n            }\r\n\r\n            const topFaceStartIndex = bottomFaceStartIndex + numTesselation + 1;\r\n\r\n            // Top faces of the frustum\r\n            for (let i = 0; i <= numTesselation; ++i) {\r\n                if (i < numTesselation) {\r\n                    this._indices.push(topFaceStartIndex + i, startFarIndices + i + numTesselation * (numTesselation + 1), topFaceStartIndex + i + 1);\r\n                    this._indices.push(\r\n                        topFaceStartIndex + i + 1,\r\n                        startFarIndices + i + numTesselation * (numTesselation + 1),\r\n                        startFarIndices + i + 1 + numTesselation * (numTesselation + 1)\r\n                    );\r\n                }\r\n            }\r\n\r\n            // Near faces of the frustum\r\n            for (let i = 0; i < numTesselation; ++i) {\r\n                this._indices.push(leftFaceStartIndex + i, leftFaceStartIndex + i + 1, topFaceStartIndex + numTesselation - i);\r\n                if (i < numTesselation - 1) {\r\n                    this._indices.push(leftFaceStartIndex + i + 1, topFaceStartIndex + numTesselation - i - 1, topFaceStartIndex + numTesselation - i);\r\n                }\r\n            }\r\n\r\n            for (let i = 0; i < numTesselation; ++i) {\r\n                this._indices.push(bottomFaceStartIndex + i, rightFaceStartIndex + numTesselation - i, rightFaceStartIndex + numTesselation - i - 1);\r\n                if (i < numTesselation - 1) {\r\n                    this._indices.push(bottomFaceStartIndex + i, rightFaceStartIndex + numTesselation - i - 1, bottomFaceStartIndex + i + 1);\r\n                }\r\n            }\r\n        } else {\r\n            this._indices.push(0, 2, 1);\r\n            this._indices.push(2, 3, 1);\r\n        }\r\n\r\n        // Tesselate the far plane\r\n        for (let iy = 0; iy <= numTesselation; ++iy) {\r\n            for (let ix = 0; ix <= numTesselation; ++ix) {\r\n                if (ix < numTesselation && iy < numTesselation) {\r\n                    this._indices.push(\r\n                        startFarIndices + ix + iy * (numTesselation + 1),\r\n                        startFarIndices + ix + 1 + iy * (numTesselation + 1),\r\n                        startFarIndices + ix + 1 + (iy + 1) * (numTesselation + 1)\r\n                    );\r\n                    this._indices.push(\r\n                        startFarIndices + ix + iy * (numTesselation + 1),\r\n                        startFarIndices + ix + 1 + (iy + 1) * (numTesselation + 1),\r\n                        startFarIndices + ix + (iy + 1) * (numTesselation + 1)\r\n                    );\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n"]}