{"version":3,"file":"thinDepthPeelingRenderer.js","sourceRoot":"","sources":["../../../../dev/core/src/Rendering/thinDepthPeelingRenderer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Implementation based on https://medium.com/@shrekshao_71662/dual-depth-peeling-implementation-in-webgl-11baa061ba4b\r\n */\r\nimport { Constants } from \"../Engines/constants\";\r\nimport type { AbstractEngine } from \"../Engines/abstractEngine\";\r\nimport type { Effect } from \"../Materials/effect\";\r\nimport { MultiRenderTarget } from \"../Materials/Textures/multiRenderTarget\";\r\nimport type { InternalTextureCreationOptions } from \"../Materials/Textures/textureCreationOptions\";\r\nimport { Color4 } from \"../Maths/math.color\";\r\nimport type { SubMesh } from \"../Meshes/subMesh\";\r\nimport type { AbstractMesh } from \"../Meshes/abstractMesh\";\r\nimport { SmartArray } from \"../Misc/smartArray\";\r\nimport type { Scene } from \"../scene\";\r\nimport { ThinTexture } from \"../Materials/Textures/thinTexture\";\r\nimport { EffectRenderer, EffectWrapper } from \"../Materials/effectRenderer\";\r\nimport type { PrePassRenderer } from \"./prePassRenderer\";\r\nimport type { IMaterialContext } from \"../Engines/IMaterialContext\";\r\nimport type { DrawWrapper } from \"../Materials/drawWrapper\";\r\nimport { Material } from \"../Materials/material\";\r\n\r\nimport \"../Engines/Extensions/engine.multiRender\";\r\nimport { ShaderLanguage } from \"core/Materials/shaderLanguage\";\r\nimport type { RenderTargetWrapper } from \"../Engines/renderTargetWrapper\";\r\nimport type { Nullable } from \"../types\";\r\n\r\n/**\r\n * @internal\r\n */\r\nexport class ThinDepthPeelingRenderer {\r\n    protected _scene: Scene;\r\n    protected _engine: AbstractEngine;\r\n    protected _depthMrts: MultiRenderTarget[] = [];\r\n    protected _thinTextures: ThinTexture[] = [];\r\n    protected _colorMrts: MultiRenderTarget[] = [];\r\n    protected _blendBackMrt: MultiRenderTarget;\r\n\r\n    protected _blendBackEffectWrapper: EffectWrapper;\r\n    protected _blendBackEffectWrapperPingPong: EffectWrapper;\r\n    protected _finalEffectWrapper: EffectWrapper;\r\n    protected _effectRenderer: EffectRenderer;\r\n\r\n    protected _currentPingPongState: number = 0;\r\n\r\n    protected _layoutCacheFormat = [[true], [true, true], [true, true, true]];\r\n    protected _layoutCache: number[][] = [];\r\n    protected _renderPassIds: number[];\r\n    protected _candidateSubMeshes: SmartArray<SubMesh> = new SmartArray(10);\r\n    protected _excludedSubMeshes: SmartArray<SubMesh> = new SmartArray(10);\r\n    protected _excludedMeshes: number[] = [];\r\n\r\n    protected static _DEPTH_CLEAR_VALUE = -99999.0;\r\n    protected static _MIN_DEPTH = 0;\r\n    protected static _MAX_DEPTH = 1;\r\n\r\n    protected _colorCache = [\r\n        new Color4(ThinDepthPeelingRenderer._DEPTH_CLEAR_VALUE, ThinDepthPeelingRenderer._DEPTH_CLEAR_VALUE, 0, 0),\r\n        new Color4(-ThinDepthPeelingRenderer._MIN_DEPTH, ThinDepthPeelingRenderer._MAX_DEPTH, 0, 0),\r\n        new Color4(0, 0, 0, 0),\r\n    ];\r\n\r\n    protected _passCount: number;\r\n    /**\r\n     * Number of depth peeling passes. As we are using dual depth peeling, each pass two levels of transparency are processed.\r\n     */\r\n    public get passCount(): number {\r\n        return this._passCount;\r\n    }\r\n\r\n    public set passCount(count: number) {\r\n        if (this._passCount === count) {\r\n            return;\r\n        }\r\n        this._passCount = count;\r\n        this._createRenderPassIds();\r\n    }\r\n\r\n    protected _useRenderPasses: boolean;\r\n    /**\r\n     * Instructs the renderer to use render passes. It is an optimization that makes the rendering faster for some engines (like WebGPU) but that consumes more memory, so it is disabled by default.\r\n     */\r\n    public get useRenderPasses() {\r\n        return this._useRenderPasses;\r\n    }\r\n\r\n    public set useRenderPasses(usePasses: boolean) {\r\n        if (this._useRenderPasses === usePasses) {\r\n            return;\r\n        }\r\n        this._useRenderPasses = usePasses;\r\n        this._createRenderPassIds();\r\n    }\r\n\r\n    /**\r\n     * Add a mesh in the exclusion list to prevent it to be handled by the depth peeling renderer\r\n     * @param mesh The mesh to exclude from the depth peeling renderer\r\n     */\r\n    public addExcludedMesh(mesh: AbstractMesh): void {\r\n        if (this._excludedMeshes.indexOf(mesh.uniqueId) === -1) {\r\n            this._excludedMeshes.push(mesh.uniqueId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Remove a mesh from the exclusion list of the depth peeling renderer\r\n     * @param mesh The mesh to remove\r\n     */\r\n    public removeExcludedMesh(mesh: AbstractMesh): void {\r\n        const index = this._excludedMeshes.indexOf(mesh.uniqueId);\r\n        if (index !== -1) {\r\n            this._excludedMeshes.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    /** Shader language used by the renderer */\r\n    protected _shaderLanguage = ShaderLanguage.GLSL;\r\n\r\n    /**\r\n     * Gets the shader language used in this renderer\r\n     */\r\n    public get shaderLanguage(): ShaderLanguage {\r\n        return this._shaderLanguage;\r\n    }\r\n\r\n    private _blendOutput: Nullable<RenderTargetWrapper>;\r\n    /**\r\n     * Sets the render target wrapper we will blend the transparent objects onto\r\n     */\r\n    public get blendOutput(): Nullable<RenderTargetWrapper> {\r\n        return this._blendOutput;\r\n    }\r\n\r\n    public set blendOutput(blendOutput: Nullable<RenderTargetWrapper>) {\r\n        this._blendOutput = blendOutput;\r\n        this._disposeTextures();\r\n        if (blendOutput) {\r\n            this._createTextures();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Instanciates the depth peeling renderer\r\n     * @param scene Scene to attach to\r\n     * @param passCount Number of depth layers to peel\r\n     * @returns The depth peeling renderer\r\n     */\r\n    constructor(scene: Scene, passCount: number = 5) {\r\n        this._scene = scene;\r\n        this._engine = scene.getEngine();\r\n        this._passCount = passCount;\r\n\r\n        for (let i = 0; i < this._layoutCacheFormat.length; ++i) {\r\n            this._layoutCache[i] = this._engine.buildTextureLayout(this._layoutCacheFormat[i]);\r\n        }\r\n\r\n        this._renderPassIds = [];\r\n        this.useRenderPasses = false;\r\n\r\n        if (this._engine.isWebGPU) {\r\n            this._shaderLanguage = ShaderLanguage.WGSL;\r\n        }\r\n\r\n        this._createEffects(\"oitFinalSimpleBlend\", [\"uFrontColor\"]);\r\n    }\r\n\r\n    private _createRenderPassIds(): void {\r\n        this._releaseRenderPassIds();\r\n        if (this._useRenderPasses) {\r\n            for (let i = 0; i < this._passCount + 1; ++i) {\r\n                if (!this._renderPassIds[i]) {\r\n                    this._renderPassIds[i] = this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${i}`);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _releaseRenderPassIds(): void {\r\n        for (let i = 0; i < this._renderPassIds.length; ++i) {\r\n            this._engine.releaseRenderPassId(this._renderPassIds[i]);\r\n        }\r\n        this._renderPassIds = [];\r\n    }\r\n\r\n    protected _getTextureSize(): { width: number; height: number } {\r\n        if (this._blendOutput) {\r\n            return {\r\n                width: this._blendOutput.width,\r\n                height: this._blendOutput.height,\r\n            };\r\n        }\r\n        return { width: this._engine.getRenderWidth(), height: this._engine.getRenderHeight() };\r\n    }\r\n\r\n    // TODO : support multiview for WebXR stereo rendering.\r\n    // Currently, the MRTs created here are mono (2D textures), so depth peeling only produces correct\r\n    // order-independent transparency for one view. In XR with OVR_multiview2, transparent objects that\r\n    // partially overlap other transparent objects may render incorrectly in one or both eyes â€” fragments\r\n    // behind a transparent surface can disappear or flicker depending on camera angle.\r\n    // To fix this, the MultiRenderTargets should use 2-layer texture arrays when the active XR session\r\n    // uses multiview, and the peeling shaders (oitBackBlend, oitFinal) should be updated to read/write\r\n    // via gl_ViewID_OVR so both eyes are peeled in a single pass.\r\n    protected _createTextures() {\r\n        const size = this._getTextureSize();\r\n\r\n        // 2 for ping pong\r\n        this._depthMrts = [\r\n            new MultiRenderTarget(\"depthPeelingDepth0MRT\", size, 3, this._scene, undefined, [\r\n                \"depthPeelingDepth0MRT_depth\",\r\n                \"depthPeelingDepth0MRT_frontColor\",\r\n                \"depthPeelingDepth0MRT_backColor\",\r\n            ]),\r\n            new MultiRenderTarget(\"depthPeelingDepth1MRT\", size, 3, this._scene, undefined, [\r\n                \"depthPeelingDepth1MRT_depth\",\r\n                \"depthPeelingDepth1MRT_frontColor\",\r\n                \"depthPeelingDepth1MRT_backColor\",\r\n            ]),\r\n        ];\r\n        this._colorMrts = [\r\n            new MultiRenderTarget(\"depthPeelingColor0MRT\", size, 2, this._scene, { generateDepthBuffer: false }, [\r\n                \"depthPeelingColor0MRT_frontColor\",\r\n                \"depthPeelingColor0MRT_backColor\",\r\n            ]),\r\n            new MultiRenderTarget(\"depthPeelingColor1MRT\", size, 2, this._scene, { generateDepthBuffer: false }, [\r\n                \"depthPeelingColor1MRT_frontColor\",\r\n                \"depthPeelingColor1MRT_backColor\",\r\n            ]),\r\n        ];\r\n        this._blendBackMrt = new MultiRenderTarget(\"depthPeelingBackMRT\", size, 1, this._scene, { generateDepthBuffer: false }, [\"depthPeelingBackMRT_blendBack\"]);\r\n        if (this._blendOutput) {\r\n            this._blendBackMrt.setInternalTexture(this._blendOutput.texture!, 0);\r\n        }\r\n\r\n        // 0 is a depth texture\r\n        // 1 is a color texture\r\n        const optionsArray = [\r\n            {\r\n                format: Constants.TEXTUREFORMAT_RG,\r\n                samplingMode: Constants.TEXTURE_NEAREST_SAMPLINGMODE,\r\n                type: this._engine.getCaps().textureFloatLinearFiltering ? Constants.TEXTURETYPE_FLOAT : Constants.TEXTURETYPE_HALF_FLOAT,\r\n                label: \"DepthPeelingRenderer-DepthTexture\",\r\n            } as InternalTextureCreationOptions,\r\n            {\r\n                format: Constants.TEXTUREFORMAT_RGBA,\r\n                samplingMode: Constants.TEXTURE_NEAREST_SAMPLINGMODE,\r\n                type: Constants.TEXTURETYPE_HALF_FLOAT,\r\n                label: \"DepthPeelingRenderer-ColorTexture\",\r\n            } as InternalTextureCreationOptions,\r\n        ];\r\n\r\n        for (let i = 0; i < 2; i++) {\r\n            const depthTexture = this._engine._createInternalTexture(size, optionsArray[0], false);\r\n            const frontColorTexture = this._engine._createInternalTexture(size, optionsArray[1], false);\r\n            const backColorTexture = this._engine._createInternalTexture(size, optionsArray[1], false);\r\n\r\n            this._depthMrts[i].setInternalTexture(depthTexture, 0);\r\n            this._depthMrts[i].setInternalTexture(frontColorTexture, 1);\r\n            this._depthMrts[i].setInternalTexture(backColorTexture, 2);\r\n            this._colorMrts[i].setInternalTexture(frontColorTexture, 0);\r\n            this._colorMrts[i].setInternalTexture(backColorTexture, 1);\r\n\r\n            this._thinTextures.push(new ThinTexture(depthTexture), new ThinTexture(frontColorTexture), new ThinTexture(backColorTexture));\r\n        }\r\n\r\n        if (this._blendOutput) {\r\n            this._blendOutput.shareDepth(this._depthMrts[0].renderTarget!);\r\n        }\r\n    }\r\n\r\n    protected _disposeTextures() {\r\n        for (let i = 0; i < this._thinTextures.length; i++) {\r\n            this._thinTextures[i].dispose();\r\n        }\r\n\r\n        for (let i = 0; i < this._depthMrts.length; i++) {\r\n            this._depthMrts[i].dispose(true);\r\n            this._colorMrts[i].dispose(true);\r\n            this._blendBackMrt.dispose(true);\r\n        }\r\n\r\n        this._thinTextures = [];\r\n        this._colorMrts = [];\r\n        this._depthMrts = [];\r\n    }\r\n\r\n    protected _createEffects(finalEffectFragmentShaderName: string, finalEffectSamplerNames: string[]) {\r\n        this._blendBackEffectWrapper = new EffectWrapper({\r\n            fragmentShader: \"oitBackBlend\",\r\n            useShaderStore: true,\r\n            engine: this._engine,\r\n            samplerNames: [\"uBackColor\"],\r\n            uniformNames: [],\r\n            shaderLanguage: this._shaderLanguage,\r\n            extraInitializationsAsync: async () => {\r\n                if (this._shaderLanguage === ShaderLanguage.WGSL) {\r\n                    await import(\"../ShadersWGSL/oitBackBlend.fragment\");\r\n                } else {\r\n                    await import(\"../Shaders/oitBackBlend.fragment\");\r\n                }\r\n            },\r\n        });\r\n        this._blendBackEffectWrapperPingPong = new EffectWrapper({\r\n            fragmentShader: \"oitBackBlend\",\r\n            useShaderStore: true,\r\n            engine: this._engine,\r\n            samplerNames: [\"uBackColor\"],\r\n            uniformNames: [],\r\n            shaderLanguage: this._shaderLanguage,\r\n            extraInitializationsAsync: async () => {\r\n                if (this._shaderLanguage === ShaderLanguage.WGSL) {\r\n                    await import(\"../ShadersWGSL/oitBackBlend.fragment\");\r\n                } else {\r\n                    await import(\"../Shaders/oitBackBlend.fragment\");\r\n                }\r\n            },\r\n        });\r\n\r\n        this._finalEffectWrapper = new EffectWrapper({\r\n            fragmentShader: finalEffectFragmentShaderName,\r\n            useShaderStore: true,\r\n            engine: this._engine,\r\n            samplerNames: finalEffectSamplerNames,\r\n            uniformNames: [],\r\n            shaderLanguage: this._shaderLanguage,\r\n            extraInitializationsAsync: async () => {\r\n                if (this._shaderLanguage === ShaderLanguage.WGSL) {\r\n                    await import(\"../ShadersWGSL/oitFinalSimpleBlend.fragment\");\r\n                } else {\r\n                    await import(\"../Shaders/oitFinalSimpleBlend.fragment\");\r\n                }\r\n            },\r\n        });\r\n\r\n        this._effectRenderer = new EffectRenderer(this._engine);\r\n    }\r\n\r\n    /**\r\n     * Links to the prepass renderer\r\n     * @param _prePassRenderer The scene PrePassRenderer\r\n     */\r\n    public setPrePassRenderer(_prePassRenderer: PrePassRenderer) {}\r\n\r\n    /**\r\n     * Binds depth peeling textures on an effect\r\n     * @param effect The effect to bind textures on\r\n     */\r\n    public bind(effect: Effect) {\r\n        effect.setTexture(\"oitDepthSampler\", this._thinTextures[this._currentPingPongState * 3]);\r\n        effect.setTexture(\"oitFrontColorSampler\", this._thinTextures[this._currentPingPongState * 3 + 1]);\r\n    }\r\n\r\n    private _renderSubMeshes(transparentSubMeshes: SmartArray<SubMesh>) {\r\n        let mapMaterialContext: { [uniqueId: number]: IMaterialContext | undefined };\r\n        if (this._useRenderPasses) {\r\n            mapMaterialContext = {};\r\n        }\r\n        for (let j = 0; j < transparentSubMeshes.length; j++) {\r\n            const material = transparentSubMeshes.data[j].getMaterial();\r\n            let previousShaderHotSwapping = true;\r\n            let previousBFC = false;\r\n\r\n            const subMesh = transparentSubMeshes.data[j];\r\n            let drawWrapper: DrawWrapper | undefined;\r\n            let firstDraw = false;\r\n\r\n            if (this._useRenderPasses) {\r\n                drawWrapper = subMesh._getDrawWrapper();\r\n                firstDraw = !drawWrapper;\r\n            }\r\n\r\n            if (material) {\r\n                previousShaderHotSwapping = material.allowShaderHotSwapping;\r\n                previousBFC = material.backFaceCulling;\r\n                material.allowShaderHotSwapping = false;\r\n                material.backFaceCulling = false;\r\n            }\r\n\r\n            subMesh.render(false);\r\n\r\n            if (firstDraw) {\r\n                // first time we draw this submesh: we replace the material context\r\n                drawWrapper = subMesh._getDrawWrapper()!; // we are sure it is now non empty as we just rendered the submesh\r\n                if (drawWrapper.materialContext) {\r\n                    let newMaterialContext = mapMaterialContext![drawWrapper.materialContext.uniqueId];\r\n                    if (!newMaterialContext) {\r\n                        newMaterialContext = mapMaterialContext![drawWrapper.materialContext.uniqueId] = this._engine.createMaterialContext();\r\n                    }\r\n                    subMesh._getDrawWrapper()!.materialContext = newMaterialContext;\r\n                }\r\n            }\r\n\r\n            if (material) {\r\n                material.allowShaderHotSwapping = previousShaderHotSwapping;\r\n                material.backFaceCulling = previousBFC;\r\n            }\r\n        }\r\n    }\r\n\r\n    protected _finalCompose(writeId: number) {\r\n        this._engine.bindFramebuffer(this._blendOutput!);\r\n\r\n        this._engine.setAlphaMode(Constants.ALPHA_PREMULTIPLIED);\r\n        this._engine.depthCullingState.depthMask = false;\r\n        this._engine.depthCullingState.depthTest = false;\r\n        this._engine.applyStates();\r\n\r\n        this._engine.enableEffect(this._finalEffectWrapper.drawWrapper);\r\n        this._finalEffectWrapper.effect.setTexture(\"uFrontColor\", this._thinTextures[writeId * 3 + 1]);\r\n        this._effectRenderer.render(this._finalEffectWrapper);\r\n    }\r\n\r\n    /**\r\n     * Checks if the depth peeling renderer is ready to render transparent meshes\r\n     * @returns true if the depth peeling renderer is ready to render the transparent meshes\r\n     */\r\n    public isReady() {\r\n        return this._blendBackEffectWrapper.effect.isReady() && this._blendBackEffectWrapperPingPong.effect.isReady() && this._finalEffectWrapper.effect.isReady();\r\n    }\r\n\r\n    protected _beforeRender() {}\r\n\r\n    protected _afterRender() {}\r\n\r\n    protected _noTransparentMeshes() {}\r\n\r\n    /**\r\n     * Renders transparent submeshes with depth peeling\r\n     * @param transparentSubMeshes List of transparent meshes to render\r\n     * @returns The array of submeshes that could not be handled by this renderer\r\n     */\r\n    public render(transparentSubMeshes: SmartArray<SubMesh>): SmartArray<SubMesh> {\r\n        this._candidateSubMeshes.length = 0;\r\n        this._excludedSubMeshes.length = 0;\r\n        if (!this.isReady()) {\r\n            return this._excludedSubMeshes;\r\n        }\r\n\r\n        if (this._scene.activeCamera) {\r\n            this._engine.setViewport(this._scene.activeCamera.viewport);\r\n        }\r\n\r\n        for (let i = 0; i < transparentSubMeshes.length; i++) {\r\n            const subMesh = transparentSubMeshes.data[i];\r\n            const material = subMesh.getMaterial();\r\n            const fillMode = material && subMesh.getRenderingMesh()._getRenderingFillMode(material.fillMode);\r\n\r\n            if (\r\n                material &&\r\n                (fillMode === Material.TriangleFanDrawMode || fillMode === Material.TriangleFillMode || fillMode === Material.TriangleStripDrawMode) &&\r\n                this._excludedMeshes.indexOf(subMesh.getMesh().uniqueId) === -1\r\n            ) {\r\n                this._candidateSubMeshes.push(subMesh);\r\n            } else {\r\n                this._excludedSubMeshes.push(subMesh);\r\n            }\r\n        }\r\n\r\n        if (!this._candidateSubMeshes.length) {\r\n            this._noTransparentMeshes();\r\n            return this._excludedSubMeshes;\r\n        }\r\n\r\n        const currentRenderPassId = this._engine.currentRenderPassId;\r\n\r\n        this._beforeRender();\r\n\r\n        if (this._useRenderPasses) {\r\n            this._engine.currentRenderPassId = this._renderPassIds[0];\r\n        }\r\n\r\n        // Clears\r\n        this._engine.bindFramebuffer(this._depthMrts[0].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[0]);\r\n        this._engine.clear(this._colorCache[0], true, false, false);\r\n        this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget!);\r\n\r\n        this._engine.bindFramebuffer(this._depthMrts[1].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[0]);\r\n        this._engine.clear(this._colorCache[1], true, false, false);\r\n        this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget!);\r\n\r\n        this._engine.bindFramebuffer(this._colorMrts[0].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[1]);\r\n        this._engine.clear(this._colorCache[2], true, false, false);\r\n        this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget!);\r\n\r\n        this._engine.bindFramebuffer(this._colorMrts[1].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[1]);\r\n        this._engine.clear(this._colorCache[2], true, false, false);\r\n        this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget!);\r\n\r\n        // Draw depth for first pass\r\n        this._engine.bindFramebuffer(this._depthMrts[0].renderTarget!);\r\n        this._engine.bindAttachments(this._layoutCache[0]);\r\n\r\n        this._engine.setAlphaMode(Constants.ALPHA_ONEONE_ONEONE); // in WebGPU, when using MIN or MAX equation, the src / dst color factors should not use SRC_ALPHA and the src / dst alpha factors must be 1 else WebGPU will throw a validation error\r\n        this._engine.setAlphaEquation(Constants.ALPHA_EQUATION_MAX);\r\n        this._engine.depthCullingState.depthMask = false;\r\n        this._engine.depthCullingState.depthTest = true;\r\n        this._engine.applyStates();\r\n\r\n        this._currentPingPongState = 1;\r\n        // Render\r\n        this._renderSubMeshes(this._candidateSubMeshes);\r\n        this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget!);\r\n\r\n        this._scene.resetCachedMaterial();\r\n\r\n        // depth peeling ping-pong\r\n        let readId = 0;\r\n        let writeId = 0;\r\n\r\n        for (let i = 0; i < this._passCount; i++) {\r\n            readId = i % 2;\r\n            writeId = 1 - readId;\r\n            this._currentPingPongState = readId;\r\n\r\n            if (this._useRenderPasses) {\r\n                this._engine.currentRenderPassId = this._renderPassIds[i + 1];\r\n            }\r\n\r\n            if (this._scene.activeCamera) {\r\n                this._engine.setViewport(this._scene.activeCamera.viewport);\r\n            }\r\n\r\n            // Clears\r\n            this._engine.bindFramebuffer(this._depthMrts[writeId].renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[0]);\r\n            this._engine.clear(this._colorCache[0], true, false, false);\r\n            this._engine.unBindFramebuffer(this._depthMrts[writeId].renderTarget!);\r\n\r\n            this._engine.bindFramebuffer(this._colorMrts[writeId].renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[1]);\r\n            this._engine.clear(this._colorCache[2], true, false, false);\r\n            this._engine.unBindFramebuffer(this._colorMrts[writeId].renderTarget!);\r\n\r\n            this._engine.bindFramebuffer(this._depthMrts[writeId].renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[2]);\r\n\r\n            this._engine.setAlphaMode(Constants.ALPHA_ONEONE_ONEONE); // the value does not matter (as MAX operation does not use them) but the src and dst color factors should not use SRC_ALPHA else WebGPU will throw a validation error\r\n            this._engine.setAlphaEquation(Constants.ALPHA_EQUATION_MAX);\r\n            this._engine.depthCullingState.depthTest = false;\r\n            this._engine.applyStates();\r\n\r\n            // Render\r\n            this._renderSubMeshes(this._candidateSubMeshes);\r\n            this._engine.unBindFramebuffer(this._depthMrts[writeId].renderTarget!);\r\n\r\n            this._scene.resetCachedMaterial();\r\n\r\n            // Back color\r\n            this._engine.bindFramebuffer(this._blendBackMrt.renderTarget!);\r\n            this._engine.bindAttachments(this._layoutCache[0]);\r\n            this._engine.setAlphaEquation(Constants.ALPHA_EQUATION_ADD);\r\n            this._engine.setAlphaMode(Constants.ALPHA_LAYER_ACCUMULATE);\r\n            this._engine.applyStates();\r\n\r\n            const blendBackEffectWrapper = writeId === 0 || !this._useRenderPasses ? this._blendBackEffectWrapper : this._blendBackEffectWrapperPingPong;\r\n            this._engine.enableEffect(blendBackEffectWrapper.drawWrapper);\r\n            blendBackEffectWrapper.effect.setTexture(\"uBackColor\", this._thinTextures[writeId * 3 + 2]);\r\n            this._effectRenderer.render(blendBackEffectWrapper);\r\n            this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget!);\r\n        }\r\n\r\n        this._engine.currentRenderPassId = currentRenderPassId;\r\n\r\n        // Final composition on default FB\r\n        this._finalCompose(writeId);\r\n\r\n        this._engine.setAlphaMode(Constants.ALPHA_DISABLE);\r\n\r\n        this._engine.depthCullingState.depthMask = true;\r\n        this._engine.depthCullingState.depthTest = true;\r\n\r\n        this._afterRender();\r\n\r\n        return this._excludedSubMeshes;\r\n    }\r\n\r\n    /**\r\n     * Disposes the depth peeling renderer and associated resources\r\n     */\r\n    public dispose() {\r\n        this._disposeTextures();\r\n        this._blendBackEffectWrapper.dispose();\r\n        this._finalEffectWrapper.dispose();\r\n        this._effectRenderer.dispose();\r\n        this._releaseRenderPassIds();\r\n    }\r\n}\r\n"]}